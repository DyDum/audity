<ReglesCIS>
  <Regle id="4.1.1">
    <CheminBase>/etc/nginx/</CheminBase>
    <NomFichier>nginx.conf</NomFichier>
    <RegleNonConforme>HTTP is not redirected to HTTPS, which exposes unencrypted traffic to interception.</RegleNonConforme>
    <RegleCorrigee>Configure a 301 redirect from HTTP to HTTPS in the NGINX configuration.</RegleCorrigee>
    <Correction>echo 'server { listen 80; return 301 https://$host$request_uri; }' >> /etc/nginx/nginx.conf</Correction>
    <Verification>curl -I http://localhost | grep -q '301 Moved Permanently' && echo 0 || echo 1</Verification>
  </Regle>

  <Regle id="4.1.2">
    <CheminBase>/etc/ssl/certs/</CheminBase>
    <NomFichier>nginx-selfsigned.crt</NomFichier>
    <RegleNonConforme>A self-signed or untrusted SSL certificate is used, which reduces trust.</RegleNonConforme>
    <RegleCorrigee>Install a trusted SSL certificate from a trusted Certificate Authority (CA).</RegleCorrigee>
    <Correction>openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout /etc/ssl/private/nginx-selfsigned.key -out /etc/ssl/certs/nginx-selfsigned.crt</Correction>
    <Verification>openssl x509 -in /etc/ssl/certs/nginx-selfsigned.crt -noout -issuer | grep -q 'CA' && echo 0 || echo 1</Verification>
  </Regle>

  <Regle id="4.1.3">
    <CheminBase>/etc/ssl/private/</CheminBase>
    <NomFichier>nginx-selfsigned.key</NomFichier>
    <RegleNonConforme>The private key has weak or improper permissions, making it vulnerable to unauthorized access.</RegleNonConforme>
    <RegleCorrigee>Restrict the private key permissions to root only (600).</RegleCorrigee>
    <Correction>chmod 600 /etc/ssl/private/nginx-selfsigned.key; chown root:root /etc/ssl/private/nginx-selfsigned.key</Correction>
    <Verification>stat -c "%a %U:%G" /etc/ssl/private/nginx-selfsigned.key | grep -q '600 root:root' && echo 0 || echo 1</Verification>
  </Regle>

  <Regle id="4.1.4">
    <CheminBase>/etc/nginx/</CheminBase>
    <NomFichier>nginx.conf</NomFichier>
    <RegleNonConforme>Weak or deprecated SSL/TLS protocols are enabled, increasing vulnerability to attacks.</RegleNonConforme>
    <RegleCorrigee>Restrict SSL/TLS protocols to TLS 1.2 and TLS 1.3 only.</RegleCorrigee>
    <Correction>echo 'ssl_protocols TLSv1.2 TLSv1.3;' >> /etc/nginx/nginx.conf</Correction>
    <Verification>nginx -T | grep -q 'ssl_protocols TLSv1.2 TLSv1.3;' && echo 0 || echo 1</Verification>
  </Regle>

  <Regle id="4.1.5">
    <CheminBase>/etc/nginx/</CheminBase>
    <NomFichier>nginx.conf</NomFichier>
    <RegleNonConforme>Weak SSL/TLS ciphers are enabled, increasing the risk of exploitation.</RegleNonConforme>
    <RegleCorrigee>Disable weak SSL/TLS ciphers in the configuration.</RegleCorrigee>
    <Correction>echo 'ssl_ciphers "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256";' >> /etc/nginx/nginx.conf</Correction>
    <Verification>nginx -T | grep -q 'ssl_ciphers' && echo 0 || echo 1</Verification>
  </Regle>

  <Regle id="4.1.6">
    <CheminBase>/etc/nginx/</CheminBase>
    <NomFichier>nginx.conf</NomFichier>
    <RegleNonConforme>Custom Diffie-Hellman parameters are not used, reducing security.</RegleNonConforme>
    <RegleCorrigee>Use custom Diffie-Hellman parameters for secure key exchange.</RegleCorrigee>
    <Correction>openssl dhparam -out /etc/ssl/certs/dhparam.pem 2048; echo 'ssl_dhparam /etc/ssl/certs/dhparam.pem;' >> /etc/nginx/nginx.conf</Correction>
    <Verification>nginx -T | grep -q 'ssl_dhparam' && echo 0 || echo 1</Verification>
  </Regle>

  <Regle id="4.1.7">
    <CheminBase>/etc/nginx/</CheminBase>
    <NomFichier>nginx.conf</NomFichier>
    <RegleNonConforme>OCSP stapling is not enabled, increasing SSL handshake time and reducing security.</RegleNonConforme>
    <RegleCorrigee>Enable OCSP Stapling in the SSL configuration.</RegleCorrigee>
    <Correction>echo 'ssl_stapling on; ssl_stapling_verify on; ssl_trusted_certificate /etc/ssl/certs/nginx-selfsigned.crt;' >> /etc/nginx/nginx.conf</Correction>
    <Verification>nginx -T | grep -q 'ssl_stapling on;' && echo 0 || echo 1</Verification>
  </Regle>

  <Regle id="4.1.8">
    <CheminBase>/etc/nginx/</CheminBase>
    <NomFichier>nginx.conf</NomFichier>
    <RegleNonConforme>HTTP Strict Transport Security (HSTS) is not enabled, reducing HTTPS security.</RegleNonConforme>
    <RegleCorrigee>Enable HSTS in the NGINX configuration.</RegleCorrigee>
    <Correction>echo 'add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload";' >> /etc/nginx/nginx.conf</Correction>
    <Verification>nginx -T | grep -q 'Strict-Transport-Security' && echo 0 || echo 1</Verification>
  </Regle>

  <Regle id="4.1.9">
    <CheminBase>/etc/nginx/</CheminBase>
    <NomFichier>nginx.conf</NomFichier>
    <RegleNonConforme>Upstream server traffic is not authenticated with a client certificate, reducing security.</RegleNonConforme>
    <RegleCorrigee>Configure client certificate authentication for upstream server traffic.</RegleCorrigee>
    <Correction>echo 'proxy_ssl_certificate /etc/ssl/certs/client.crt; proxy_ssl_certificate_key /etc/ssl/private/client.key;' >> /etc/nginx/nginx.conf</Correction>
    <Verification>nginx -T | grep -q 'proxy_ssl_certificate' && echo 0 || echo 1</Verification>
  </Regle>

  <Regle id="4.1.10">
    <CheminBase>/etc/nginx/</CheminBase>
    <NomFichier>nginx.conf</NomFichier>
    <RegleNonConforme>The upstream server certificate is not verified, making the server vulnerable to Man-in-the-Middle attacks.</RegleNonConforme>
    <RegleCorrigee>Configure NGINX to verify the upstream server certificate using a trusted CA certificate.</RegleCorrigee>
    <Correction>echo 'proxy_ssl_trusted_certificate /etc/ssl/certs/ca-certificates.crt; proxy_ssl_verify on;' >> /etc/nginx/nginx.conf</Correction>
    <Verification>nginx -T | grep -q 'proxy_ssl_verify on;' && echo 0 || echo 1</Verification>
  </Regle>

  <Regle id="4.1.11">
    <CheminBase>/etc/nginx/</CheminBase>
    <NomFichier>nginx.conf</NomFichier>
    <RegleNonConforme>Your domain is not preloaded in HSTS, reducing the effectiveness of HTTPS.</RegleNonConforme>
    <RegleCorrigee>Configure HSTS with the preload directive and submit your domain for HSTS preload.</RegleCorrigee>
    <Correction>echo 'add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload";' >> /etc/nginx/nginx.conf</Correction>
    <Verification>nginx -T | grep -q 'Strict-Transport-Security.*preload' && echo 0 || echo 1</Verification>
  </Regle>

  <Regle id="4.1.12">
    <CheminBase>/etc/nginx/</CheminBase>
    <NomFichier>nginx.conf</NomFichier>
    <RegleNonConforme>SSL session resumption is enabled, reducing the benefits of Perfect Forward Secrecy (PFS).</RegleNonConforme>
    <RegleCorrigee>Disable SSL session resumption for PFS.</RegleCorrigee>
    <Correction>echo 'ssl_session_cache off;' >> /etc/nginx/nginx.conf</Correction>
    <Verification>nginx -T | grep -q 'ssl_session_cache off;' && echo 0 || echo 1</Verification>
  </Regle>

  <Regle id="4.1.13">
    <CheminBase>/etc/nginx/</CheminBase>
    <NomFichier>nginx.conf</NomFichier>
    <RegleNonConforme>HTTP/2.0 is not enabled, which reduces the performance of HTTPS connections.</RegleNonConforme>
    <RegleCorrigee>Enable HTTP/2.0 for HTTPS connections in NGINX.</RegleCorrigee>
    <Correction>sed -i 's/listen 443 ssl;/listen 443 ssl http2;/' /etc/nginx/nginx.conf</Correction>
    <Verification>nginx -T | grep -q 'listen 443 ssl http2;' && echo 0 || echo 1</Verification>
  </Regle>

  <Regle id="4.1.14">
    <CheminBase>/etc/nginx/</CheminBase>
    <NomFichier>nginx.conf</NomFichier>
    <RegleNonConforme>Perfect Forward Secrecy (PFS) ciphers are not enforced, reducing SSL/TLS security.</RegleNonConforme>
    <RegleCorrigee>Restrict SSL/TLS ciphers to only PFS-compatible ciphers (ECDHE).</RegleCorrigee>
    <Correction>echo 'ssl_ciphers "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256";' >> /etc/nginx/nginx.conf</Correction>
    <Verification>nginx -T | grep -q 'ssl_ciphers' && echo 0 || echo 1</Verification>
  </Regle>
</ReglesCIS>
