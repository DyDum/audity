<RulesCIS>
    <Rule id="2.3.3.1">
        <Name>Ensure chrony is configured with authorized timeserver (Automated)</Name>
        <Chapter id="2">Services</Chapter>
        <Section id="2.3">Configure Time Synchronization</Section>
        <SubSection id="2.3.3">Configure chrony</SubSection>
        <SubSubSection id="2.3.3.1">Ensure chrony is configured with authorized timeserver</SubSubSection>
        <Profiles>
            <Profile level="1" type="Server"/>
            <Profile level="1" type="Workstation"/>
        </Profiles>
        <BasePath>/etc/chrony/</BasePath>
        <FileName>chrony.conf</FileName>
        <NonCompliantComment>Chrony is not configured with an approved time server.</NonCompliantComment>
        <CorrectiveComment>Add an approved server line to /etc/chrony/chrony.conf and restart chrony.</CorrectiveComment>
        <Correction><![CDATA[sed -i 's/^server .*/server pool.ntp.org iburst/' /etc/chrony/chrony.conf; systemctl restart chrony]]></Correction>
        <Verification><![CDATA[grep -q "^server pool.ntp.org" /etc/chrony/chrony.conf && systemctl is-active chrony | grep -q active && echo 0 || echo 1]]></Verification>
        <Manual>NO</Manual>
    </Rule>

    <Rule id="2.3.3.2">
        <Name>Ensure chrony runs as _chrony user (Automated)</Name>
        <Chapter id="2">Services</Chapter>
        <Section id="2.3">Configure Time Synchronization</Section>
        <SubSection id="2.3.3">Configure chrony</SubSection>
        <SubSubSection id="2.3.3.2">Ensure chrony runs as _chrony user</SubSubSection>
        <Profiles>
            <Profile level="1" type="Server"/>
            <Profile level="1" type="Workstation"/>
        </Profiles>
        <BasePath>/etc/chrony/</BasePath>
        <FileName>chrony.conf</FileName>
        <NonCompliantComment>Chrony is not running under the dedicated _chrony user.</NonCompliantComment>
        <CorrectiveComment>Ensure chronyd runs as the _chrony user.</CorrectiveComment>
        <Correction><![CDATA[usermod -a -G _chrony chrony; systemctl restart chrony]]></Correction>
        <Verification><![CDATA[ps -o user= -C chronyd | grep -q "^_chrony$" && echo 0 || echo 1]]></Verification>
        <Manual>NO</Manual>
    </Rule>

    <Rule id="2.3.3.3">
        <Name>Ensure chrony is enabled and running (Automated)</Name>
        <Chapter id="2">Services</Chapter>
        <Section id="2.3">Configure Time Synchronization</Section>
        <SubSection id="2.3.3">Configure chrony</SubSection>
        <SubSubSection id="2.3.3.3">Ensure chrony is enabled and running</SubSubSection>
        <Profiles>
            <Profile level="1" type="Server"/>
            <Profile level="1" type="Workstation"/>
        </Profiles>
        <BasePath>/etc/systemd/system/</BasePath>
        <FileName>chrony.service</FileName>
        <NonCompliantComment>Chrony is not enabled or running, which may lead to inaccurate system time.</NonCompliantComment>
        <CorrectiveComment>Enable and start chrony.</CorrectiveComment>
        <Correction><![CDATA[systemctl enable --now chrony]]></Correction>
        <Verification><![CDATA[systemctl is-active chrony | grep -q active && echo 0 || echo 1]]></Verification>
        <Manual>NO</Manual>
    </Rule>
</RulesCIS>