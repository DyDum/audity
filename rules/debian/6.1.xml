<RulesCIS>

    <!-- ═════════ 6  Logging and Auditing  →  6.1 System Logging ═════════ -->

    <!-- ───────────── 6.1.2  Configure journald ───────────── -->

    <Rule id="6.1.2.1.1">
        <Name>Ensure journald ForwardToSyslog is disabled (Automated)</Name>
        <Chapter id="6">Logging and Auditing</Chapter>
        <Section id="6.1">System Logging</Section>
        <SubSection id="6.1.2">Configure journald</SubSection>
        <SubSubSection id="6.1.2.1">Configure systemd-journal-remote</SubSubSection>
        <Profiles>
            <Profile level="1" type="Server"/>
            <Profile level="1" type="Workstation"/>
        </Profiles>
        <BasePath>/etc/systemd/journald.conf</BasePath>
        <FileName>journald.conf</FileName>
        <NonCompliantComment>Log forwarding is enabled (or not explicitly disabled).</NonCompliantComment>
        <CorrectiveComment>Set ForwardToSyslog=no.</CorrectiveComment>
        <Correction><![CDATA[sed -i 's/^#\?ForwardToSyslog=.*/ForwardToSyslog=no/' /etc/systemd/journald.conf; systemctl restart systemd-journald]]></Correction>
        <Verification><![CDATA[grep '^ForwardToSyslog=no' /etc/systemd/journald.conf && echo 0 || echo 1]]></Verification>
        <Manual>NO</Manual>
    </Rule>

    <Rule id="6.1.2.1.2">
        <Name>Ensure journald Compress is enabled (Automated)</Name>
        <Chapter id="6">Logging and Auditing</Chapter>
        <Section id="6.1">System Logging</Section>
        <SubSection id="6.1.2">Configure journald</SubSection>
        <SubSubSection id="6.1.2.1">Configure systemd-journal-remote</SubSubSection>
        <Profiles>
            <Profile level="1" type="Server"/>
            <Profile level="1" type="Workstation"/>
        </Profiles>
        <BasePath>/etc/systemd/journald.conf</BasePath>
        <FileName>journald.conf</FileName>
        <NonCompliantComment>Log compression is not enabled.</NonCompliantComment>
        <CorrectiveComment>Set Compress=yes.</CorrectiveComment>
        <Correction><![CDATA[sed -i 's/^#\?Compress=.*/Compress=yes/' /etc/systemd/journald.conf; systemctl restart systemd-journald]]></Correction>
        <Verification><![CDATA[grep '^Compress=yes' /etc/systemd/journald.conf && echo 0 || echo 1]]></Verification>
        <Manual>NO</Manual>
    </Rule>

    <Rule id="6.1.2.1.3">
        <Name>Ensure journald Storage is persistent (Automated)</Name>
        <Chapter id="6">Logging and Auditing</Chapter>
        <Section id="6.1">System Logging</Section>
        <SubSection id="6.1.2">Configure journald</SubSection>
        <SubSubSection id="6.1.2.1">Configure systemd-journal-remote</SubSubSection>
        <Profiles>
            <Profile level="1" type="Server"/>
            <Profile level="1" type="Workstation"/>
        </Profiles>
        <BasePath>/etc/systemd/journald.conf</BasePath>
        <FileName>journald.conf</FileName>
        <NonCompliantComment>The log storage mode is not persistent.</NonCompliantComment>
        <CorrectiveComment>Set Storage=persistent.</CorrectiveComment>
        <Correction><![CDATA[sed -i 's/^#\?Storage=.*/Storage=persistent/' /etc/systemd/journald.conf; systemctl restart systemd-journald]]></Correction>
        <Verification><![CDATA[grep '^Storage=persistent' /etc/systemd/journald.conf && echo 0 || echo 1]]></Verification>
        <Manual>NO</Manual>
    </Rule>

    <Rule id="6.1.2.2">
        <Name>Ensure journald Compress is enabled (Automated)</Name>
        <Chapter id="6">Logging and Auditing</Chapter>
        <Section id="6.1">System Logging</Section>
        <SubSection id="6.1.2">Configure journald</SubSection>
        <Profiles>
            <Profile level="1" type="Server"/>
            <Profile level="1" type="Workstation"/>
        </Profiles>
        <BasePath>/etc/systemd/journald.conf</BasePath>
        <FileName>journald.conf</FileName>
        <NonCompliantComment>Journald compression is not enabled.</NonCompliantComment>
        <CorrectiveComment>Enable Compress=yes.</CorrectiveComment>
        <Correction><![CDATA[sed -i 's/^#\?Compress=.*/Compress=yes/' /etc/systemd/journald.conf; systemctl restart systemd-journald]]></Correction>
        <Verification><![CDATA[grep '^Compress=yes' /etc/systemd/journald.conf && systemctl is-active systemd-journald | grep -q "active" && echo 0 || echo 1]]></Verification>
        <Manual>NO</Manual>
    </Rule>

    <Rule id="6.1.2.3">
        <Name>Ensure journald Storage is persistent (Automated)</Name>
        <Chapter id="6">Logging and Auditing</Chapter>
        <Section id="6.1">System Logging</Section>
        <SubSection id="6.1.2">Configure journald</SubSection>
        <Profiles>
            <Profile level="1" type="Server"/>
            <Profile level="1" type="Workstation"/>
        </Profiles>
        <BasePath>/etc/systemd/journald.conf</BasePath>
        <FileName>journald.conf</FileName>
        <NonCompliantComment>The storage setting is not persistent.</NonCompliantComment>
        <CorrectiveComment>Set Storage=persistent.</CorrectiveComment>
        <Correction><![CDATA[sed -i 's/^#\?Storage=.*/Storage=persistent/' /etc/systemd/journald.conf; systemctl restart systemd-journald]]></Correction>
        <Verification><![CDATA[grep '^Storage=persistent' /etc/systemd/journald.conf && systemctl is-active systemd-journald | grep -q "active" && echo 0 || echo 1]]></Verification>
        <Manual>NO</Manual>
    </Rule>


    <!-- ───────────── 6.1.3  Configure rsyslog ───────────── -->

    <Rule id="6.1.3.1">
        <Name>Ensure permissions on /var/log are configured (Automated)</Name>
        <Chapter id="6">Logging and Auditing</Chapter>
        <Section id="6.1">System Logging</Section>
        <SubSection id="6.1.3">Configure rsyslog</SubSection>
        <Profiles>
            <Profile level="1" type="Server"/>
            <Profile level="1" type="Workstation"/>
        </Profiles>
        <BasePath>/var/log</BasePath>
        <FileName>logfiles</FileName>
        <NonCompliantComment>Critical log files do not have restricted permissions.</NonCompliantComment>
        <CorrectiveComment>Set file mode 640 on all logs under /var/log.</CorrectiveComment>
        <Correction><![CDATA[find /var/log -type f -exec chmod 640 {} \;]]></Correction>
        <Verification><![CDATA[find /var/log -type f | xargs -I {} stat -c "%a" {} | grep -q "^640" && echo 0 || echo 1]]></Verification>
        <Manual>NO</Manual>
    </Rule>

    <Rule id="6.1.3.2">
        <Name>Ensure log file ownership is configured (Automated)</Name>
        <Chapter id="6">Logging and Auditing</Chapter>
        <Section id="6.1">System Logging</Section>
        <SubSection id="6.1.3">Configure rsyslog</SubSection>
        <Profiles>
            <Profile level="1" type="Server"/>
            <Profile level="1" type="Workstation"/>
        </Profiles>
        <BasePath>/var/log</BasePath>
        <FileName>ownership</FileName>
        <NonCompliantComment>Log files not consistently owned by authorized users.</NonCompliantComment>
        <CorrectiveComment>Ensure root:adm ownership on /var/log/**.</CorrectiveComment>
        <Correction><![CDATA[chown -R root:adm /var/log]]></Correction>
        <Verification><![CDATA[find /var/log -type f -exec stat -c "%U:%G" {} \; | grep -v "root:adm" && echo 1 || echo 0]]></Verification>
        <Manual>NO</Manual>
    </Rule>

    <Rule id="6.1.3.3">
        <Name>Ensure log rotation is configured (Automated)</Name>
        <Chapter id="6">Logging and Auditing</Chapter>
        <Section id="6.1">System Logging</Section>
        <SubSection id="6.1.3">Configure rsyslog</SubSection>
        <Profiles>
            <Profile level="1" type="Server"/>
            <Profile level="1" type="Workstation"/>
        </Profiles>
        <BasePath>/etc/logrotate.d/</BasePath>
        <FileName>rsyslog</FileName>
        <NonCompliantComment>Log rotation is not configured.</NonCompliantComment>
        <CorrectiveComment>Add logrotate policy for /var/log/*.log.</CorrectiveComment>
        <Correction><![CDATA[echo "/var/log/*.log { daily rotate 7 compress missingok notifempty }" > /etc/logrotate.d/rsyslog]]></Correction>
        <Verification><![CDATA[grep -q "/var/log/*.log" /etc/logrotate.d/rsyslog && echo 0 || echo 1]]></Verification>
        <Manual>NO</Manual>
    </Rule>

    <Rule id="6.1.3.4">
        <Name>Ensure separate partition exists for /var/log (Automated)</Name>
        <Chapter id="6">Logging and Auditing</Chapter>
        <Section id="6.1">System Logging</Section>
        <SubSection id="6.1.3">Configure rsyslog</SubSection>
        <Profiles>
            <Profile level="2" type="Server"/>
            <Profile level="2" type="Workstation"/>
        </Profiles>
        <BasePath>/etc/fstab</BasePath>
        <FileName>fstab</FileName>
        <NonCompliantComment>Logs stored on root partition.</NonCompliantComment>
        <CorrectiveComment>Create a dedicated /var/log partition.</CorrectiveComment>
        <Correction><![CDATA[echo "/dev/sdX /var/log ext4 defaults 0 0" >> /etc/fstab; mount -o remount /var/log]]></Correction>
        <Verification><![CDATA[grep -q "/var/log" /etc/fstab && mount | grep -q "/var/log" && echo 0 || echo 1]]></Verification>
        <Manual>NO</Manual>
    </Rule>

    <Rule id="6.1.3.5">
        <Name>Ensure remote logging is configured (Automated)</Name>
        <Chapter id="6">Logging and Auditing</Chapter>
        <Section id="6.1">System Logging</Section>
        <SubSection id="6.1.3">Configure rsyslog</SubSection>
        <Profiles>
            <Profile level="1" type="Server"/>
            <Profile level="1" type="Workstation"/>
        </Profiles>
        <BasePath>/etc/rsyslog.conf</BasePath>
        <FileName>rsyslog.conf</FileName>
        <NonCompliantComment>Remote logging not configured.</NonCompliantComment>
        <CorrectiveComment>Forward logs to remote-log-server:514.</CorrectiveComment>
        <Correction><![CDATA[echo "*.* @@remote-log-server:514" >> /etc/rsyslog.conf; systemctl restart rsyslog]]></Correction>
        <Verification><![CDATA[grep -q "@@remote-log-server:514" /etc/rsyslog.conf && echo 0 || echo 1]]></Verification>
        <Manual>NO</Manual>
    </Rule>

    <Rule id="6.1.3.6">
        <Name>Ensure log backups are performed (Automated)</Name>
        <Chapter id="6">Logging and Auditing</Chapter>
        <Section id="6.1">System Logging</Section>
        <SubSection id="6.1.3">Configure rsyslog</SubSection>
        <Profiles>
            <Profile level="1" type="Server"/>
            <Profile level="1" type="Workstation"/>
        </Profiles>
        <BasePath>/var/backups/</BasePath>
        <FileName>log_backup.sh</FileName>
        <NonCompliantComment>No scheduled log backups.</NonCompliantComment>
        <CorrectiveComment>Create daily backup of /var/log.</CorrectiveComment>
        <Correction><![CDATA[echo "tar -czf /var/backups/logs-$(date +%F).tar.gz /var/log" > /var/backups/log_backup.sh; chmod +x /var/backups/log_backup.sh; (crontab -l ; echo "0 2 * * * /var/backups/log_backup.sh") | crontab -]]></Correction>
        <Verification><![CDATA[test -f /var/backups/log_backup.sh && echo 0 || echo 1]]></Verification>
        <Manual>NO</Manual>
    </Rule>

    <Rule id="6.1.3.7">
        <Name>Ensure log file integrity is monitored (Automated)</Name>
        <Chapter id="6">Logging and Auditing</Chapter>
        <Section id="6.1">System Logging</Section>
        <SubSection id="6.1.3">Configure rsyslog</SubSection>
        <Profiles>
            <Profile level="2" type="Server"/>
            <Profile level="2" type="Workstation"/>
        </Profiles>
        <BasePath>/etc/aide.conf</BasePath>
        <FileName>aide.conf</FileName>
        <NonCompliantComment>Log integrity not monitored.</NonCompliantComment>
        <CorrectiveComment>Deploy AIDE to monitor /var/log.</CorrectiveComment>
        <Correction><![CDATA[apt-get install -y aide; aideinit; cp /var/lib/aide/aide.db.new /var/lib/aide/aide.db]]></Correction>
        <Verification><![CDATA[test -f /var/lib/aide/aide.db && echo 0 || echo 1]]></Verification>
        <Manual>NO</Manual>
    </Rule>

    <Rule id="6.1.3.8">
        <Name>Ensure custom log rotation configuration exists (Automated)</Name>
        <Chapter id="6">Logging and Auditing</Chapter>
        <Section id="6.1">System Logging</Section>
        <SubSection id="6.1.3">Configure rsyslog</SubSection>
        <Profiles>
            <Profile level="1" type="Server"/>
            <Profile level="1" type="Workstation"/>
        </Profiles>
        <BasePath>/etc/logrotate.d/</BasePath>
        <FileName>custom_logrotate.conf</FileName>
        <NonCompliantComment>Critical logs may not be rotated.</NonCompliantComment>
        <CorrectiveComment>Create dedicated logrotate policy.</CorrectiveComment>
        <Correction><![CDATA[echo "/var/log/*.log { daily rotate 7 compress missingok notifempty }" > /etc/logrotate.d/custom_logrotate.conf]]></Correction>
        <Verification><![CDATA[test -f /etc/logrotate.d/custom_logrotate.conf && grep -q "/var/log/*.log" /etc/logrotate.d/custom_logrotate.conf && echo 0 || echo 1]]></Verification>
        <Manual>NO</Manual>
    </Rule>


    <!-- ───────────── 6.1.4  Configure Logfiles ───────────── -->

    <Rule id="6.1.4.1">
        <Name>Ensure only one logging system is in use (Automated)</Name>
        <Chapter id="6">Logging and Auditing</Chapter>
        <Section id="6.1">System Logging</Section>
        <SubSection id="6.1.4">Configure Logfiles</SubSection>
        <Profiles>
            <Profile level="1" type="Server"/>
            <Profile level="1" type="Workstation"/>
        </Profiles>
        <BasePath>/</BasePath>
        <FileName>logging_system</FileName>
        <NonCompliantComment>Multiple logging systems are active.</NonCompliantComment>
        <CorrectiveComment>Disable rsyslog so only systemd-journald is active.</CorrectiveComment>
        <Correction><![CDATA[systemctl disable rsyslog; systemctl stop rsyslog]]></Correction>
        <Verification><![CDATA[systemctl is-active rsyslog | grep -q "inactive" && echo 0 || echo 1]]></Verification>
        <Manual>NO</Manual>
    </Rule>

</RulesCIS>
