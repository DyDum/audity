<RulesCIS>
    <Rule id="6.1.2.1.1">
        <Name>Ensure journald ForwardToSyslog is disabled (Automated)</Name>
        <Chapter id="6">Logging and Auditing</Chapter>
        <Section id="6.1">System Logging</Section>
        <SubSection id="6.1.2">Configure journald</SubSection>
        <SubSubSection id="6.1.2.1">Configure systemd-journal-remote</SubSubSection>
        <Profiles>
            <Profile level="1" type="Server"/>
            <Profile level="1" type="Workstation"/>
        </Profiles>
        <BasePath>/etc/systemd/journald.conf</BasePath>
        <FileName>journald.conf</FileName>
        <NonCompliantComment>Log forwarding is enabled (or not explicitly disabled).</NonCompliantComment>
        <CorrectiveComment>Set ForwardToSyslog=no.</CorrectiveComment>
        <Correction><![CDATA[systemctl unmask systemd-journald.service && systemctl start systemd-journald.service]]></Correction>
        <Verification><![CDATA[s=$(systemctl is-enabled systemd-journald.service 2>/dev/null); a=$(systemctl is-active systemd-journald.service 2>/dev/null); { [ "$s" = "static" ] || [ "$s" = "enabled" ]; } && [ "$a" = "active" ] && echo 0 || echo 1]]></Verification>
        <Manual>NO</Manual>
    </Rule>

    <Rule id="6.1.2.1.2">
        <Name>Ensure journald Compress is enabled (Automated)</Name>
        <Chapter id="6">Logging and Auditing</Chapter>
        <Section id="6.1">System Logging</Section>
        <SubSection id="6.1.2">Configure journald</SubSection>
        <SubSubSection id="6.1.2.1">Configure systemd-journal-remote</SubSubSection>
        <Profiles>
            <Profile level="1" type="Server"/>
            <Profile level="1" type="Workstation"/>
        </Profiles>
        <BasePath>/etc/systemd/journald.conf</BasePath>
        <FileName>journald.conf</FileName>
        <NonCompliantComment>Log compression is not enabled.</NonCompliantComment>
        <CorrectiveComment>Set Compress=yes.</CorrectiveComment>
        <Correction><![CDATA[find /var/log/journal /run/log/journal -type f -exec chmod 0640 {} + && find /var/log/journal /run/log/journal -type d -exec chmod 0755 {} +]]></Correction>
        <Verification><![CDATA[bad=0; for f in $(find /var/log/journal /run/log/journal -type f 2>/dev/null); do [ "$(stat -c '%a' "$f")" -le 640 ] || { echo "Bad file: $f"; bad=1; }; done; for d in $(find /var/log/journal /run/log/journal -type d 2>/dev/null); do mode=$(stat -c '%a' "$d"); [[ "$mode" == 755 || "$mode" == 2755 ]] || { echo "Bad dir: $d ($mode)"; bad=1; }; done; [ "$bad" -eq 0 ] && echo 0 || echo 1]]></Verification>
        <Manual>NO</Manual>
    </Rule>

    <Rule id="6.1.2.1.3">
        <Name>Ensure journald Storage is persistent (Automated)</Name>
        <Chapter id="6">Logging and Auditing</Chapter>
        <Section id="6.1">System Logging</Section>
        <SubSection id="6.1.2">Configure journald</SubSection>
        <SubSubSection id="6.1.2.1">Configure systemd-journal-remote</SubSubSection>
        <Profiles>
            <Profile level="1" type="Server"/>
            <Profile level="1" type="Workstation"/>
        </Profiles>
        <BasePath>/etc/systemd/journald.conf</BasePath>
        <FileName>journald.conf</FileName>
        <NonCompliantComment>The log storage mode is not persistent.</NonCompliantComment>
        <CorrectiveComment>Set Storage=persistent.</CorrectiveComment>
        <Correction><![CDATA[mkdir -p /etc/systemd/journald.conf.d && printf '[Journal]\nSystemMaxUse=1G\nSystemKeepFree=500M\nRuntimeMaxUse=200M\nRuntimeKeepFree=50M\nMaxFileSec=1month\n' > /etc/systemd/journald.conf.d/60-journald.conf && systemctl restart systemd-journald]]></Correction>
        <Verification><![CDATA[conf_files=$(find /etc/systemd/journald.conf /etc/systemd/journald.conf.d -type f -name '*.conf' 2>/dev/null); grep -Eq '^\s*(SystemMaxUse|SystemKeepFree|RuntimeMaxUse|RuntimeKeepFree|MaxFileSec)\s*=' $conf_files && echo 0 || echo 1]]></Verification>
        <Manual>NO</Manual>
    </Rule>

    <Rule id="6.1.1.4">
        <Name>Ensure only one logging system is in use (Automated)</Name>
        <Chapter id="6">Logging and Auditing</Chapter>
        <Section id="6.1">System Logging</Section>
        <SubSection id="6.1.1">Configure journald service</SubSection>
        <Profiles>
            <Profile level="1" type="Server"/>
            <Profile level="1" type="Workstation"/>
        </Profiles>
        <BasePath>/etc/systemd/</BasePath>
        <FileName>journald.conf</FileName>
        <NonCompliantComment>Multiple logging systems (rsyslog and journald) are active simultaneously.</NonCompliantComment>
        <CorrectiveComment>Ensure only one logging system is active (either journald or rsyslog).</CorrectiveComment>
        <Correction><![CDATA[systemctl stop rsyslog && systemctl disable rsyslog && systemctl restart systemd-journald]]></Correction>
        <Verification><![CDATA[(systemctl is-active --quiet rsyslog && ! systemctl is-active --quiet systemd-journald) || (! systemctl is-active --quiet rsyslog && systemctl is-active --quiet systemd-journald) && echo 0 || echo 1]]></Verification>
        <Manual>NO</Manual>
    </Rule>

    <Rule id="6.1.2.1.1">
        <Name>Ensure systemd-journal-remote is installed (Automated)</Name>
        <Chapter id="6">Logging and Auditing</Chapter>
        <Section id="6.1">System Logging</Section>
        <SubSection id="6.1.2">Configure journald</SubSection>
        <Profiles>
            <Profile level="1" type="Server"/>
            <Profile level="1" type="Workstation"/>
        </Profiles>
        <BasePath>/usr/bin</BasePath>
        <FileName>systemd-journal-remote</FileName>
        <NonCompliantComment>systemd-journal-remote is not installed.</NonCompliantComment>
        <CorrectiveComment>Install systemd-journal-remote using apt.</CorrectiveComment>
        <Correction><![CDATA[apt install -y systemd-journal-remote]]></Correction>
        <Verification><![CDATA[dpkg-query -s systemd-journal-remote &>/dev/null && echo 0 || echo 1]]></Verification>
        <Manual>NO</Manual>
    </Rule>

    <Rule id="6.1.2.1.2">
        <Name>Ensure systemd-journal-upload authentication is configured (Manual)</Name>
        <Chapter id="6">Logging and Auditing</Chapter>
        <Section id="6.1">System Logging</Section>
        <SubSection id="6.1.2">Configure journald</SubSection>
        <Profiles>
            <Profile level="1" type="Server"/>
            <Profile level="1" type="Workstation"/>
        </Profiles>
        <BasePath>/etc/systemd/journal-upload.conf.d</BasePath>
        <FileName>60-journald_upload.conf</FileName>
        <NonCompliantComment>Missing or incomplete authentication parameters for journal upload.</NonCompliantComment>
        <CorrectiveComment>Set URL, ServerKeyFile, ServerCertificateFile and TrustedCertificateFile in the [Upload] section.</CorrectiveComment>
        <Correction><![CDATA[grep -q '^URL=' /etc/systemd/journal-upload.conf.d/60-journald_upload.conf && grep -q '^ServerKeyFile=' /etc/systemd/journal-upload.conf.d/60-journald_upload.conf && grep -q '^ServerCertificateFile=' /etc/systemd/journal-upload.conf.d/60-journald_upload.conf && grep -q '^TrustedCertificateFile=' /etc/systemd/journal-upload.conf.d/60-journald_upload.conf && echo 0 || echo 1]]></Correction>
        <Verification><![CDATA[grep -q '^URL=' /etc/systemd/journal-upload.conf.d/60-journald_upload.conf && grep -q '^ServerKeyFile=' /etc/systemd/journal-upload.conf.d/60-journald_upload.conf && grep -q '^ServerCertificateFile=' /etc/systemd/journal-upload.conf.d/60-journald_upload.conf && grep -q '^TrustedCertificateFile=' /etc/systemd/journal-upload.conf.d/60-journald_upload.conf && echo 0 || echo 1]]></Verification>
        <Manual>YES</Manual>
    </Rule>

    <Rule id="6.1.2.2">
        <Name>Ensure journald Compress is enabled (Automated)</Name>
        <Chapter id="6">Logging and Auditing</Chapter>
        <Section id="6.1">System Logging</Section>
        <SubSection id="6.1.2">Configure journald</SubSection>
        <Profiles>
            <Profile level="1" type="Server"/>
            <Profile level="1" type="Workstation"/>
        </Profiles>
        <BasePath>/etc/systemd/journald.conf</BasePath>
        <FileName>journald.conf</FileName>
        <NonCompliantComment>Journald compression is not enabled.</NonCompliantComment>
        <CorrectiveComment>Enable Compress=yes.</CorrectiveComment>
        <Correction><![CDATA[sed -i 's/^#\?Compress=.*/Compress=yes/' /etc/systemd/journald.conf; systemctl restart systemd-journald]]></Correction>
        <Verification><![CDATA[grep '^Compress=yes' /etc/systemd/journald.conf && systemctl is-active systemd-journald | grep -q "active" && echo 0 || echo 1]]></Verification>
        <Manual>NO</Manual>
    </Rule>

    <Rule id="6.1.2.3">
        <Name>Ensure journald Storage is persistent (Automated)</Name>
        <Chapter id="6">Logging and Auditing</Chapter>
        <Section id="6.1">System Logging</Section>
        <SubSection id="6.1.2">Configure journald</SubSection>
        <Profiles>
            <Profile level="1" type="Server"/>
            <Profile level="1" type="Workstation"/>
        </Profiles>
        <BasePath>/etc/systemd/journald.conf</BasePath>
        <FileName>journald.conf</FileName>
        <NonCompliantComment>The storage setting is not persistent.</NonCompliantComment>
        <CorrectiveComment>Set Storage=persistent.</CorrectiveComment>
        <Correction><![CDATA[sed -i 's/^#\?Storage=.*/Storage=persistent/' /etc/systemd/journald.conf; systemctl restart systemd-journald]]></Correction>
        <Verification><![CDATA[grep '^Storage=persistent' /etc/systemd/journald.conf && systemctl is-active systemd-journald | grep -q "active" && echo 0 || echo 1]]></Verification>
        <Manual>NO</Manual>
    </Rule>


    <!-- ───────────── 6.1.3  Configure rsyslog ───────────── -->

    <Rule id="6.1.3.1">
        <Name>Ensure permissions on /var/log are configured (Automated)</Name>
        <Chapter id="6">Logging and Auditing</Chapter>
        <Section id="6.1">System Logging</Section>
        <SubSection id="6.1.3">Configure rsyslog</SubSection>
        <Profiles>
            <Profile level="1" type="Server"/>
            <Profile level="1" type="Workstation"/>
        </Profiles>
        <BasePath>/var/log</BasePath>
        <FileName>logfiles</FileName>
        <NonCompliantComment>Critical log files do not have restricted permissions.</NonCompliantComment>
        <CorrectiveComment>Set file mode 640 on all logs under /var/log.</CorrectiveComment>
        <Correction><![CDATA[find /var/log -type f -exec chmod 640 {} \;]]></Correction>
        <Verification><![CDATA[find /var/log -type f | xargs -I {} stat -c "%a" {} | grep -q "^640" && echo 0 || echo 1]]></Verification>
        <Manual>NO</Manual>
    </Rule>

    <Rule id="6.1.3.2">
        <Name>Ensure log file ownership is configured (Automated)</Name>
        <Chapter id="6">Logging and Auditing</Chapter>
        <Section id="6.1">System Logging</Section>
        <SubSection id="6.1.3">Configure rsyslog</SubSection>
        <Profiles>
            <Profile level="1" type="Server"/>
            <Profile level="1" type="Workstation"/>
        </Profiles>
        <BasePath>/var/log</BasePath>
        <FileName>ownership</FileName>
        <NonCompliantComment>Log files not consistently owned by authorized users.</NonCompliantComment>
        <CorrectiveComment>Ensure root:adm ownership on /var/log/**.</CorrectiveComment>
        <Correction><![CDATA[chown -R root:adm /var/log]]></Correction>
        <Verification><![CDATA[find /var/log -type f -exec stat -c "%U:%G" {} \; | grep -v "root:adm" && echo 1 || echo 0]]></Verification>
        <Manual>NO</Manual>
    </Rule>

    <Rule id="6.1.3.3">
        <Name>Ensure log rotation is configured (Automated)</Name>
        <Chapter id="6">Logging and Auditing</Chapter>
        <Section id="6.1">System Logging</Section>
        <SubSection id="6.1.3">Configure rsyslog</SubSection>
        <Profiles>
            <Profile level="1" type="Server"/>
            <Profile level="1" type="Workstation"/>
        </Profiles>
        <BasePath>/etc/logrotate.d/</BasePath>
        <FileName>rsyslog</FileName>
        <NonCompliantComment>Log rotation is not configured.</NonCompliantComment>
        <CorrectiveComment>Add logrotate policy for /var/log/*.log.</CorrectiveComment>
        <Correction><![CDATA[echo "/var/log/*.log { daily rotate 7 compress missingok notifempty }" > /etc/logrotate.d/rsyslog]]></Correction>
        <Verification><![CDATA[grep -q "/var/log/*.log" /etc/logrotate.d/rsyslog && echo 0 || echo 1]]></Verification>
        <Manual>NO</Manual>
    </Rule>

    <Rule id="6.1.3.4">
        <Name>Ensure separate partition exists for /var/log (Automated)</Name>
        <Chapter id="6">Logging and Auditing</Chapter>
        <Section id="6.1">System Logging</Section>
        <SubSection id="6.1.3">Configure rsyslog</SubSection>
        <Profiles>
            <Profile level="2" type="Server"/>
            <Profile level="2" type="Workstation"/>
        </Profiles>
        <BasePath>/etc/fstab</BasePath>
        <FileName>fstab</FileName>
        <NonCompliantComment>Logs stored on root partition.</NonCompliantComment>
        <CorrectiveComment>Create a dedicated /var/log partition.</CorrectiveComment>
        <Correction><![CDATA[echo "/dev/sdX /var/log ext4 defaults 0 0" >> /etc/fstab; mount -o remount /var/log]]></Correction>
        <Verification><![CDATA[grep -q "/var/log" /etc/fstab && mount | grep -q "/var/log" && echo 0 || echo 1]]></Verification>
        <Manual>NO</Manual>
    </Rule>

    <Rule id="6.1.3.5">
        <Name>Ensure remote logging is configured (Automated)</Name>
        <Chapter id="6">Logging and Auditing</Chapter>
        <Section id="6.1">System Logging</Section>
        <SubSection id="6.1.3">Configure rsyslog</SubSection>
        <Profiles>
            <Profile level="1" type="Server"/>
            <Profile level="1" type="Workstation"/>
        </Profiles>
        <BasePath>/etc/rsyslog.conf</BasePath>
        <FileName>rsyslog.conf</FileName>
        <NonCompliantComment>Remote logging not configured.</NonCompliantComment>
        <CorrectiveComment>Forward logs to remote-log-server:514.</CorrectiveComment>
        <Correction><![CDATA[echo "*.* @@remote-log-server:514" >> /etc/rsyslog.conf; systemctl restart rsyslog]]></Correction>
        <Verification><![CDATA[grep -q "@@remote-log-server:514" /etc/rsyslog.conf && echo 0 || echo 1]]></Verification>
        <Manual>NO</Manual>
    </Rule>

    <Rule id="6.1.3.6">
        <Name>Ensure log backups are performed (Automated)</Name>
        <Chapter id="6">Logging and Auditing</Chapter>
        <Section id="6.1">System Logging</Section>
        <SubSection id="6.1.3">Configure rsyslog</SubSection>
        <Profiles>
            <Profile level="1" type="Server"/>
            <Profile level="1" type="Workstation"/>
        </Profiles>
        <BasePath>/var/backups/</BasePath>
        <FileName>log_backup.sh</FileName>
        <NonCompliantComment>No scheduled log backups.</NonCompliantComment>
        <CorrectiveComment>Create daily backup of /var/log.</CorrectiveComment>
        <Correction><![CDATA[echo "tar -czf /var/backups/logs-$(date +%F).tar.gz /var/log" > /var/backups/log_backup.sh; chmod +x /var/backups/log_backup.sh; (crontab -l ; echo "0 2 * * * /var/backups/log_backup.sh") | crontab -]]></Correction>
        <Verification><![CDATA[test -f /var/backups/log_backup.sh && echo 0 || echo 1]]></Verification>
        <Manual>NO</Manual>
    </Rule>

    <Rule id="6.1.3.7">
        <Name>Ensure log file integrity is monitored (Automated)</Name>
        <Chapter id="6">Logging and Auditing</Chapter>
        <Section id="6.1">System Logging</Section>
        <SubSection id="6.1.3">Configure rsyslog</SubSection>
        <Profiles>
            <Profile level="2" type="Server"/>
            <Profile level="2" type="Workstation"/>
        </Profiles>
        <BasePath>/etc/aide.conf</BasePath>
        <FileName>aide.conf</FileName>
        <NonCompliantComment>Log integrity not monitored.</NonCompliantComment>
        <CorrectiveComment>Deploy AIDE to monitor /var/log.</CorrectiveComment>
        <Correction><![CDATA[apt-get install -y aide; aideinit; cp /var/lib/aide/aide.db.new /var/lib/aide/aide.db]]></Correction>
        <Verification><![CDATA[test -f /var/lib/aide/aide.db && echo 0 || echo 1]]></Verification>
        <Manual>NO</Manual>
    </Rule>

    <Rule id="6.1.3.8">
        <Name>Ensure custom log rotation configuration exists (Automated)</Name>
        <Chapter id="6">Logging and Auditing</Chapter>
        <Section id="6.1">System Logging</Section>
        <SubSection id="6.1.3">Configure rsyslog</SubSection>
        <Profiles>
            <Profile level="1" type="Server"/>
            <Profile level="1" type="Workstation"/>
        </Profiles>
        <BasePath>/etc/logrotate.d/</BasePath>
        <FileName>custom_logrotate.conf</FileName>
        <NonCompliantComment>Critical logs may not be rotated.</NonCompliantComment>
        <CorrectiveComment>Create dedicated logrotate policy.</CorrectiveComment>
        <Correction><![CDATA[echo "/var/log/*.log { daily rotate 7 compress missingok notifempty }" > /etc/logrotate.d/custom_logrotate.conf]]></Correction>
        <Verification><![CDATA[test -f /etc/logrotate.d/custom_logrotate.conf && grep -q "/var/log/*.log" /etc/logrotate.d/custom_logrotate.conf && echo 0 || echo 1]]></Verification>
        <Manual>NO</Manual>
    </Rule>


    <!-- ───────────── 6.1.4  Configure Logfiles ───────────── -->

    <Rule id="6.1.4.1">
        <Name>Ensure only one logging system is in use (Automated)</Name>
        <Chapter id="6">Logging and Auditing</Chapter>
        <Section id="6.1">System Logging</Section>
        <SubSection id="6.1.4">Configure Logfiles</SubSection>
        <Profiles>
            <Profile level="1" type="Server"/>
            <Profile level="1" type="Workstation"/>
        </Profiles>
        <BasePath>/</BasePath>
        <FileName>logging_system</FileName>
        <NonCompliantComment>Multiple logging systems are active.</NonCompliantComment>
        <CorrectiveComment>Disable rsyslog so only systemd-journald is active.</CorrectiveComment>
        <Correction><![CDATA[systemctl disable rsyslog; systemctl stop rsyslog]]></Correction>
        <Verification><![CDATA[systemctl is-active rsyslog | grep -q "inactive" && echo 0 || echo 1]]></Verification>
        <Manual>NO</Manual>
    </Rule>

</RulesCIS>
