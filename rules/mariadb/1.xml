<ReglesCIS>
    <Regle id="1.1">
    <CheminBase>/var/lib/mysql/</CheminBase>
    <NomFichier>N/A</NomFichier>
    <RegleNonConforme>MariaDB databases are stored on the system partition, which may impact performance and security.</RegleNonConforme>
    <RegleCorrigee>Place MariaDB databases on a non-system partition for improved security and performance.</RegleCorrigee>
    <Correction>sed -i 's|datadir=.*|datadir=/mnt/data/mysql|' /etc/mysql/mariadb.conf.d/50-server.cnf; systemctl restart mariadb</Correction>
    <Verification>grep 'datadir=/mnt/data/mysql' /etc/mysql/mariadb.conf.d/50-server.cnf && echo 0 || echo 1</Verification>
  </Regle>

  <Regle id="1.2">
    <CheminBase>/etc/mysql/</CheminBase>
    <NomFichier>mariadb.conf.d/50-server.cnf</NomFichier>
    <RegleNonConforme>MariaDB is not running under a dedicated, least-privileged account, increasing security risks.</RegleNonConforme>
    <RegleCorrigee>Ensure MariaDB runs under a dedicated, non-root, least-privileged account (e.g., 'mysql').</RegleCorrigee>
    <Correction>usermod -s /usr/sbin/nologin mysql; chown -R mysql:mysql /var/lib/mysql/</Correction>
    <Verification>ps aux | grep 'mysqld' | grep -q 'mysql' && echo 0 || echo 1</Verification>
  </Regle>

  <Regle id="1.3">
    <CheminBase>/etc/mysql/</CheminBase>
    <NomFichier>my.cnf</NomFichier>
    <RegleNonConforme>MariaDB command history is enabled, which may expose sensitive commands and passwords.</RegleNonConforme>
    <RegleCorrigee>Disable MariaDB command history by setting 'HISTFILE' to '/dev/null' in the configuration.</RegleCorrigee>
    <Correction>echo 'export HISTFILE=/dev/null' >> /etc/profile.d/mariadb.sh; chmod +x /etc/profile.d/mariadb.sh</Correction>
    <Verification>grep 'HISTFILE=/dev/null' /etc/profile.d/mariadb.sh && echo 0 || echo 1</Verification>
  </Regle>

  <Regle id="1.4">
    <CheminBase>/etc/mysql/</CheminBase>
    <NomFichier>my.cnf</NomFichier>
    <RegleNonConforme>The MYSQL_PWD environment variable is used, which exposes passwords to other users.</RegleNonConforme>
    <RegleCorrigee>Ensure the MYSQL_PWD environment variable is not used for authentication.</RegleCorrigee>
    <Correction>unset MYSQL_PWD</Correction>
    <Verification>env | grep -q 'MYSQL_PWD' && echo 1 || echo 0</Verification>
  </Regle>

  <Regle id="1.5">
    <CheminBase>/etc/mysql/</CheminBase>
    <NomFichier>my.cnf</NomFichier>
    <RegleNonConforme>Interactive login is enabled for the MariaDB account, increasing security risks.</RegleNonConforme>
    <RegleCorrigee>Disable interactive login for the MariaDB user account.</RegleCorrigee>
    <Correction>usermod -s /usr/sbin/nologin mysql</Correction>
    <Verification>grep 'mysql' /etc/passwd | grep -q '/usr/sbin/nologin' && echo 0 || echo 1</Verification>
  </Regle>

  <Regle id="1.6">
    <CheminBase>/etc/profile.d/</CheminBase>
    <NomFichier>mariadb.sh</NomFichier>
    <RegleNonConforme>The MYSQL_PWD variable is set in user profiles, which may expose passwords.</RegleNonConforme>
    <RegleCorrigee>Ensure MYSQL_PWD is not set in any user profiles.</RegleCorrigee>
    <Correction>sed -i '/MYSQL_PWD/d' /etc/profile /etc/profile.d/*</Correction>
    <Verification>grep -R 'MYSQL_PWD' /etc/profile /etc/profile.d/ && echo 1 || echo 0</Verification>
  </Regle>

  <Regle id="1.7">
    <CheminBase>/etc/mysql/</CheminBase>
    <NomFichier>mariadb.conf.d/50-server.cnf</NomFichier>
    <RegleNonConforme>MariaDB is not running under a sandbox environment, which may increase the risk of security breaches.</RegleNonConforme>
    <RegleCorrigee>Configure MariaDB to run in a sandboxed environment (e.g., AppArmor, SELinux).</RegleCorrigee>
    <Correction>aa-enforce /etc/apparmor.d/usr.sbin.mysqld</Correction>
    <Verification>aa-status | grep -q '/usr/sbin/mysqld (enforce)' && echo 0 || echo 1</Verification>
  </Regle>
</ReglesCIS>
